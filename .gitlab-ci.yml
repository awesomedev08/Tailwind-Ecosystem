image: node:14.16

stages:
    - install
    - build
    - test
    - publish

variables:
    NPM_TOKEN:
        $NPM_TOKEN

        ###############################################################################
#     install                                                         #
###############################################################################

install:
    stage: install
    only:
        - merge_requests
        - develop
        - main
    before_script:
        - echo -e 'Warming up the cache'
    script:
        - npm i
    cache:
        key: $CI_PROJECT_ID
        policy: pull-push
        paths:
            - node_modules

    ###############################################################################
#     build                                                         #
###############################################################################

build:
    stage: build
    only:
        - merge_requests
        - develop
        - main
    before_script:
        - npm i
    script:
        - npm run build-lib
    dependencies:
        - install
    ###############################################################################
#     test                                                         #
###############################################################################

test:
    stage: test
    needs:
        - install
        - build
    before_script:
        - npm i
    script:
        - npm run test
    only:
        - merge_requests
        - develop
        - main
    dependencies:
        - install
        - build

        ###############################################################################
#     publish                                                         #
###############################################################################

publish:
    stage: publish
    only:
        - main
    before_script:
        - npm i
        - npm run build-lib
    script:
        - echo '//registry.npmjs.org/:_authToken=${NPM_TOKEN}'>.npmrc
        - npm publish
    dependencies:
        - install
        - build
